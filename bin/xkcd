#!/usr/bin/env ruby

require 'bundler'
Bundler.require
Dotenv.load

$LOAD_PATH.unshift "#{File.dirname(__FILE__)}/../lib"

require 'freefeed/api'
require 'xkcd_feed'
require 'logger'

logger = Logger.new($stdout)
db = Sequel.connect('sqlite://feeds.sqlite', loggers: [logger])

# db.drop_table(:posts) if db.table_exists?(:posts)

db.table_exists?(:posts) || db.create_table(:posts) do
  primary_key :id

  String :title
  String :link, unique: true
  String :content
  String :image_url
  String :freefeed_post_id
  DateTime :created_at

  index :link
end

class Post < Sequel::Model(:posts)
  set_primary_key :id
end

XkcdFeed.recent.each do |item|
  next unless Post.where(link: item[:link]).count.zero?
  ap Post.create(item.merge(created_at: Time.now.utc))
end

api = Freefeed::API.new(ENV['FREEFEED_TOKEN'])

Post.where(freefeed_post_id: nil).each do |post|
  logger.info '---> create new attachment'
  re = api.create_attachment(open(post.image_url))
  attach_id = re['attachments']['id']
  logger.info "attachment id: #{attach_id}"

  logger.info '---> create new post'
  re = api.create_post("#{post.title} - #{post.link}",
    feeds: ['xkcd'], attachments: [attach_id])

  post_id = re['posts']['id']
  logger.info "post id: #{post_id}"
  post.update(freefeed_post_id: post_id)

  logger.info '---> create comment'
  api.create_comment(post_id, post.content)
end
